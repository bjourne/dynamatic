# LSQ_Sizing 

This folder contains the code used for lsq sizing. This is the version we used for the FPT 22 submission.

The depth of the lsq will be calculated based on the input throughput. There are two types of throughput: constant and variable. 

The throughput and the optimal LSQ size depend on the input data given to the benchmark. Three cases have been considered in the paper: no collisions, half collisions and all collisions. 

For some benchmarks the input throughput can be directly computed by dynamatic. The others need to use the input throughputs that have been specified in the Regression_test/throughputs_inputs folder.

---

## Compilation

**** This VM already contains a compiled version of dynamatic and of this module.

For compiling the code, run the following commands:

```bash
bash build.sh
```

The script will compile the lsq_sizing module and add it to the flow of dynamatic. In case dynamatic has been modified execute again these commands.

---

## Dependencies

For running the lsq-sizing code, `graphviz, graphviz-dev ,pkg-config` and `cbc(Coin-or branch and cut)` are needed, which can be installed with the following command:

```bash
sudo apt install graphviz
sudo apt install graphviz-dev
sudo apt install pkg-config
sudo apt install coinor-cbc
```

---

## Example Usage

**IMPORTANT**

For running this flow, two throughput files need to be created in the corresponding test_case folder in the Regression_test folder. For example, if we want to test example `simple_lsq_test_1`, following files shall be created in the test folder:

- `simple_lsq_test_1_worst_II.log`: which contains the constant throughput value. Each line refers to a different MGs (Marked Graph) in the example.

- `simple_lsq_test_1_variable_II.log`: which contains the variable throughput value for different MGs (Marked Graph) in the example.

There is also another file that is automatically generated by the flow (if specified):

- `simple_lsq_test_1_best_II.log`: which contains the contant throughput value for different MGs (Marked Graph) in the example. This value can be directly computed by dynamatic

In each one of the logs, each line corresponds to the throughput of each MG written following the same order of dynamatic.

After creating those two files, the lsq-sizing flow can be run with:

```bash
lsq_sizing -filepath=path -case=selected_case
```

Here, `-case` refers to the type of throughput input:

-case=0: the input file is automatically generated by the flow (only for some benchmarks this throughput corresponds to the correct one)

-case=1: the input throughput is given by the user following the format "BENCHMARK_NAME_worst_II.log" and inserted in the reports folder. In this case the throughput is constant

-case=2: the input throughput is given by the user following the format "BENCHMARK_NAME_variable_II.log" and inserted in the reports folder. In this case the throughput is variable

`-filepath` indicates the location of the generated `.dot` file after the buffer insertion flow.

For example:

```
lsq_sizing -filepath=./reports/simple_lsq_test_1 -case=0
```

The output is a dot file containing the computed LSQ sizes and it is saved in the `reports` folder of the example. In this case it corresponds to `./reports/simple_lsq_test_1_optimized_lsq.dot`. 
The script `dot2vhdl` can be used to obtain the corresponding vhdl file. 

---

## Main Files:

- `DFnetlist_path_finding.cpp`: contains the main parts of the lsq-sizing flow. If you want to change the depth calculation flow, you should change this file.

- `DFnetlist_lsq_param.cpp`: contains the code for changing the output dot files, which will be used for lsq generation. If you want to change the generation of lsq, you should change this file.


---

## Usefule scripts

- `depth_expolration.py`:
  - Location: `Regression_test/scripts`
  - We used this script to get the exhaustive test result of the optimal size of the LSQ and generate the graph in the FPT 22 paper. 
  - The whole script can be divided into 7 stages which are detailly commented in the script. It can 
    - Desired testcases can be specified at the beginning of the script.
    - Automatically generate all needed files for the depth exploration 
    - Run all simulation in parallel
    - Gather the result and generate an exploration log file per test case including 
      - `EXAMPLE_NAME`
      - `LOAD_DEPTH`
      - `STORE_DEPTH`
      - `EXECUTION_TIME`

- `result_analyzer.py`:
  - Location: `Regression_test/scripts`
  - This script can automatically gather the execution time for the specified test_case




